---
title: "Metricas y diversidad de paisaje de la cuena del río Aconcagua"
author: "Joaquín Riquelme Alarcón, Francisco Zambrano Bigiarini y Iongel Durán Llacer"
date: "`r Sys.Date()`"
format: html
lang: es
editor: visual
bibliography: ../01entrada/dinamicaAgroecosistema.bib
---

```{r preambulo, echo=FALSE, results='hide'}
library(sf)
library(terra)
library(tidyverse)
library(landscapemetrics)


```

### 1. Cobertura de suelo

Para la estimación de las métricas y diversidad de paisaje se utilizará como base la clasificación de usos y coberturas de suelo **hhh**

-   Clasificacion propia
-   CR2LUC CR2
-   LCM de Copernicus

```{r lclu, echo=TRUE}

area_file <- "../01entrada/cuencaAconcagua.shp"
# subsubcuenca de Aconcagua 05420
# area_file <- "../01entrada/subsubcuencaAconcagua05420.shp"

area_estudio_sf <- st_read(area_file) |>
  select(1)|>
  st_transform(crs = 4326)

plot(area_estudio_sf)
crs(area_estudio_sf)

ae_vec <-  vect(area_estudio_sf)

# lclu <- terra::rast("../01entrada/lcf/CR2LUC_v1.0_lcf_2017_001deg.nc")
# lclu$lcf_100

# plot(lclu$lcf_100)

# lcm1 <- terra::rast("../01entrada/LCFM_LCM-10_V100_2020_S33W072_cog/LCFM_LCM-10_V100_2020_S33W072_MAP.tif")
# lcm2 <- terra::rast("../01entrada/LCFM_LCM-10_V100_2020_S36W072_cog/LCFM_LCM-10_V100_2020_S36W072_MAP.tif")

# lcm <- mosaic(lcm1, lcm2)

# terra::writeRaster(lcm, filename = "../03salida/lcm2020.tif")
lcm <- terra::rast("../03salida/lcm2020.tif")

lcm.ae <- crop(lcm, area_estudio_sf)
plot(lcm.ae)

lcm.cuenca <- mask(lcm.ae, area_estudio_sf)
lcm.cuenca <- crop(lcm.cuenca, area_estudio_sf)
plot(lcm.cuenca)


conteo.clases <- freq(lcm.cuenca)
conteo.clases

res(lcm.cuenca)
lcm.cuenca

lcm.cuenca19s <- project(lcm.cuenca, "epsg:32719", method="mode")
lcm.cuenca19s

terra::writeRaster(lcm.cuenca19s, filename = "../03salida/lcm.aconcagua.2020.19s.tif")

plot(lcm.cuenca19s)
sum(freq(lcm.cuenca19s))
class(lcm.cuenca19s)

```

#### 1.2 Clases de cobertura

```{r clases, echo=FALSE}

unique(lcm.cuenca)

lc.clases <- rbind.data.frame(c("10", "Tree cover"),
                              c("20", "Shrubland"),
                              c("30", "Grassland"),
                              c("40", "Cropland"),
                              c("50", "Herbaceous wetland"),
                              c("60", "Mangroves"),
                              c("70", "Moss and lichen"),
                              c("80", "Bare/sparse vegetation"),
                              c("90", "Built-up"),
                              c("100", "Permanent water bodies"),
                              c("110", "Snow and ice"),
                              c("254", "Unclassified"))

names(lc.clases) <- c("Clase", "Leyenda")
lc.clases

```

### 2. Periodos de estudio

### 3. Cálculo de métricas de paisaje

El estudio del paisaje se pue Los parches pueden agruparse en clases con categorías definidas. Las métricas de paisaje son variables que se obtienen a partir del tamaño, forma, conectividad y diversidad de los parches presentes en el paisaje. Las métricas de tamaño muestra la cantidad de clases distintas que existen en un espacio y el tama

Los cálculos se hicieron con el paquete *landscapemetrics* . Las métricas se calculan a nivel de parche, clase y paisaje.

#### 3.1 Métricas a nivel de parche

```{r parche, echo=FALSE}

terra::crs(lcm.cuenca)
# lcm.cuenca19s <- project(lcm.cuenca, "epsg:32719")

res(lcm.cuenca19s)
ncell(lcm.cuenca19s)
(res(lcm.cuenca19s)[1])^2*ncell(lcm.cuenca19s)/1000000

View(landscapemetrics::list_lsm())

patches_landscape <- landscapemetrics::get_patches(landscape = lcm.cuenca19s, return_raster = FALSE, to_disk = TRUE)
# patches_landscape_raster <- landscapemetrics::get_patches(landscape = lcm.cuenca19s, return_raster = TRUE, to_disk = FALSE)
patches_landscape$layer_1$class_10[1000:1010,1:10]
str(patches_landscape)
lcm.cuenca19s

r1 <- rast(patches_landscape$layer_1$class_10, crs="epsg:32719", extent=ext(lcm.cuenca19s) )
plot(r1)

r2 <- rast(patches_landscape$layer_1$class_20, crs="epsg:32719", extent=ext(lcm.cuenca19s) )
plot(r2)

terra::writeRaster(x = patches_landscape$layer_1, filename = "../03salida/patches.tif")

# area de parche
p_area <- landscapemetrics::lsm_p_area(lcm.cuenca19s)

head(p_area)

p_area |> group_by(class) |> summarise(area=sum(value),
                                       mean=mean(value),
                                       sd=sd(value)); gc()

# mapa de parches y area

# distancia euclideana al vecino mas cercano
p_enn <- landscapemetrics::lsm_p_enn(lcm.cuenca19s)

p_enn |> group_by(class) |> summarise(mean.dist=mean(value),
                                      min.dist=min(value),
                                      max.dist=max(value))

# forma
p_shape <- landscapemetrics::lsm_p_shape(lcm.cuenca19s)
p_shape |> group_by(class) |> summarise(mean=mean(value))

p_contig <- landscapemetrics::lsm_p_contig(lcm.cuenca19s)
p_contig |> group_by(class) |> summarise(mean=mean(value))

```

#### 3.2 Metricas a nivel de clase

```{r clase, echo=FALSE}

c_ai <- landscapemetrics::lsm_c_ai(lcm.cuenca19s)
c_ca <- landscapemetrics::lsm_c_ca(lcm.cuenca19s)
c_cohesion <- landscapemetrics::lsm_c_cohesion(lcm.cuenca19s)
c_np <- landscapemetrics::lsm_c_np(lcm.cuenca19s)
c_pd <- landscapemetrics::lsm_c_pd(lcm.cuenca19s)
c_te <- landscapemetrics::lsm_c_te(lcm.cuenca19s)

```

#### 3.3 Metricas a nivel de paisaje

```{r paisaje, echo=FALSE}
l_ai <- landscapemetrics::lsm_l_ai(lcm.cuenca19s)
l_np <- landscapemetrics::lsm_l_np(lcm.cuenca19s)
l_pd <- landscapemetrics::lsm_l_pd(lcm.cuenca19s)
l_pr <- landscapemetrics::lsm_l_pr(lcm.cuenca19s)
l_prd <- landscapemetrics::lsm_l_prd(lcm.cuenca19s)
l_ta <- landscapemetrics::lsm_l_ta(lcm.cuenca19s)


```

#### 3.4 Diversidad beta

```{r}
landscapemetrics::list_lsm()
```
