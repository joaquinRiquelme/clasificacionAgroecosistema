---
title: "Clasificación supervisada de coberturas de uso de suelo en la cuenca del río Aconcagua"
author: "Joaquín Riquelme Alarcón, Francisco Zambrano Bigiarini y Iongel Durán Llacer"
date: "`r Sys.Date()`"
format: html
lang: es
editor: visual
bibliography: ../01entrada/dinamicaAgroecosistema.bib
---

```{r preambulo, echo=FALSE, warning=FALSE, error=FALSE, results='hide', include=FALSE}

# devtools::install_github("ranghetti/sen2r")
# librerias 
library(dplyr)
library(tidyverse)
library(sf)
library(terra) 

# library(sen2r)

library(ggplot2)
library(leaflet)
library(RColorBrewer)

library(randomForest)
library(caret)
set.seed(2025)

```

### 1. Área y período de estudio

# Área de estudio la cuenca del río Aconcagua

La cuenca del río Aconcagua es de tipo exorreica y recorre 200 km desde su nacimiento en la cordillera en el oeste hasta su desembocadura en el océano Pacífico por el este (Ver figura @fig-mapa. El río Aconcagua nace de la suma de las aguas provenientes de la cordillera de Los Andes, la cordillera de La Costa y de los cerros transversales que componen el paisaje de la región de Valparaíso en la zona central de Chile [@munoz_aguayo_redefinicion_2014]. Esta cuenca se encuentra en una zona de transición entre climas semiarido por el norte a templado mediterráneo por el sur . Las precipitaciones provienen principalmente de los ciclones del pacífico y tienen una estacionalidad marcada en invierno entre los meses de mayo y septiembre [@webb_water_2021]. Otro aporte de agua proviene de las neblinas costeras que influyen sobre la zona baja de la cuenca. La zona media se caracteriza por valles y lomas con zonas regadas y de secano. En la zona alta de la cuenca los glaciares y nieves aportan agua en primavera y comienzos del verano [@bown_recent_2008].

Figura Área de estudio


```{r area, echo=FALSE, message=FALSE, warning=FALSE}
#| label: fig-mapa
#| fig-cap: "Cuenca del río Aconcagua, región de Valparíso, Chile."
# cuenca de Aconcagua
# area_file <- "../01entrada/cuencaAconcagua.shp"
# subsubcuenca de Aconcagua 05420
area_file <- "../01entrada/subsubcuencaAconcagua05420.shp" 

area_estudio_sf <- st_read(area_file, quiet = TRUE) |>
  select(1)|>
  st_transform(crs = 4326)

# plot(area_estudio_sf)
# crs(area_estudio_sf)

ae_vec <-  vect(area_estudio_sf)
# plot(ae_vec)
# mapa base con leaflet

plet(ae_vec)
```

Se define el año para los datos de entrenamiento y la ventana de tiempo para las imágenes satelitales.

```{r tiempo, eval=FALSE}
# año de entrenamiento}
anho_train <- "2014"
# anho_train <- "2017"
# anho_train <- "2020"

# rango de fechas de imagenes
fecha_inicio <- "2024-01-01"
fecha_fin <- "2024-03-31"
```

### 2. Parámetros de imagenes satelitales

Definicion de bandas y nubosidad a utilizar para la clasificacion supervisada.

```{r parametros, echo=TRUE, include=FALSE, eval=FALSE}

# Porcentaje maximo de nubosidad permitido
nubosidad_max <- 100 

# Seleccionar las bandas a utilizar para la clasificación
# B2: Azul, B3: Verde, B4: Rojo, B8: NIR
bandas_clasi <- c("B02", "B03", "B04", "B08")#, "B11", "B12")

#tiles_19_H_CD_S2A_MSIL1C_20150808T144816_N0204_R096_T19HCD_20150808T144817.SAFE_GRANULE_L1C_T19HCD_A000665_20150808T144817_IMG_DATA_T19HCD_20150808T144816_B04

imagenes <- list.files("../03salida/", pattern = "\\.jp2", full.names = TRUE)

# leer las imagenes en un raster de terra
capas <- rast(imagenes)
plot(capas)

crs(capas)

# reproyectar y cortar al area de estudio
capas_geo <- project(capas, crs(area_estudio_sf))
capas_crop <- crop(capas_geo, ae_vec)
names(capas_crop) <- c("B02", "B03", "B04", "B08") 
capas_mask <- terra::mask(x = capas_crop, mask = ae_vec)
names(capas_mask) <- c("B02", "B03", "B04", "B08") 

capas_mask <- trim(capas_mask)
capas_mask[is.na(capas_mask)] <- 0


plot(capas_mask)
plot(capas_mask[[4]])
crs(capas_mask)
crs(area_estudio_sf)
writeRaster(capas_mask, "../03salida/capas_mask.tif", overwrite = TRUE)

capas_mask <- terra::rast("../03salida/capas_mask.tif")

```

### 3. Clasificación supervisada con polígonos de entrenamiento

```{r clasificacion, echo=TRUE, include=FALSE, eval=FALSE}
# stack con bandas 
# bandas_stack <- rast(capas_mask)
bandas_stack <- rast(capas_crop)
bandas_stack <- rast(capas_mask)
plot(bandas_stack)
crs(bandas_stack)
# Preparar datos de entrenamiento
train_path <- "../01entrada/catfrut_valparaiso.gpkg"
st_layers(train_path)

train <- st_read(train_path, layer =  anho_train) |>
  select("ESPECIE") |>
  st_transform(crs = 4326) 
  # st_crop(st_bbox(area_estudio_sf))
sf_use_s2(FALSE)
train_crop <- st_crop(train, st_bbox(area_estudio_sf))
train_inter <- st_intersection(train, area_estudio_sf) |>
  select("ESPECIE")
plot(train_crop)
plot(train_inter)

# rasterizar poligonos de entrenamiento para que cada pixel contenga la informacion
train_rast <-terra:: rasterize(train_inter, capas_crop, field="ESPECIE")
train_pol <- as.polygons(train_rast, dissolve=FALSE)

plot(train_rast)
plot(train_pol)

# cruce de valores de entrenamiento y bandas
train_vals <- terra::extract(capas_mask, train_pol, df = TRUE)
head(train_vals)
train_df   <- cbind(train_vals, class = train_pol$ESPECIE)
head(train_df)
train_df <- train_df |>
  select(-"ID")

head(train_df)
write_csv(train_df, file = "../03salida/train_df.csv")

train_df2 <- train_df[sample(1:nrow(train_df), size = nrow(train_df)*.01, replace = FALSE),]
write_csv(train_df2, file = "../03salida/train_df2.csv")

train_df2 <- read_csv(file = "../03salida/train_df2.csv")

# modelos con tidymodels
library(tidymodels)

head(train_df2)
str(train_df2)

train_df2$class <- as.factor(train_df2$class)

# dividir los datos
datos_split <- initial_split(train_df2, prop = 0.8, strata = class) 
# strata = class asegura que la proporción de cada clase sea similar en ambos sets

datos_train <- training(datos_split)
datos_test  <- testing(datos_split)

# Preprocesamiento con recipes
datos_recipe <- recipe(class ~ ., data = datos_train) %>%
  step_normalize(all_predictors()) 

# Especificación del modelo
rf_datos <- rand_forest(mode = "classification") %>%
  set_engine("ranger")

# Combinar en un "workflow"
datos_wf <- workflow() %>%
  add_recipe(datos_recipe) %>%
  add_model(rf_datos)

# Ajustar el modelo
# La función fit() entrena el modelo usando el workflow y los datos de entrenamiento
rf_fit <- fit(datos_wf, data = datos_train)


# Guardar modelo
saveRDS(rf_fit, file = "../03salida/rf_fit.RDS")

```


### 4. Evaluación de la clasificación


```{r evaluacion, echo=TRUE, include=FALSE, eval=FALSE}
# Evaluación del modelo
datos_test_predictions <- predict(rf_fit, new_data = datos_test, type = "class") %>%
  bind_cols(datos_test)

# Calculamos la exactitud (accuracy)
accuracy(datos_test_predictions, truth = class, estimate = .pred_class)

# Calculamos la matriz de confusión
conf_mat(datos_test_predictions, truth = class, estimate = .pred_class)


clasificacion0 <- terra::predict(capas_mask, #mask=TRUE,
                                rf_fit, 
                                type = "class")#, cores = events)


plot(clasificacion0, main = "Clasificación Random Forest supervisada")


class(clasificacion0)
clasificacion_mask <- terra::mask(x = clasificacion0, mask = ae_vec)
plot(clasificacion_mask)
writeRaster(clasificacion_mask, "../03salida/clasificacion2014.tif", overwrite = TRUE)

# 

# Validación cruzada y ajuste de hiperparámetros
ctrl <- trainControl(method = "cv", number = 5)
tune_grid <- expand.grid(.mtry = c(2, 3, 4))



rf_model <- train(
  class ~ .,
  data = train_df2,
  method = "rf",
  tuneGrid = tune_grid,
  trControl = ctrl,
  ntree = 500
)


# Guardar modelo
saveRDS(rf_model, file = "../03salida/modelo_rf.rds")
# rf_model <- readRDS("modelo_rf.rds")

# Prediccion en el area de estudio
clasificacion0 <- terra::predict(capas_mask, #mask=TRUE,
                                rf_model$finalModel, 
                                type = "response")#, cores = events)

plot(clasificacion0, main = "Clasificación Random Forest supervisada")


class(clasificacion0)
clasificacion_mask <- terra::mask(x = clasificacion0, mask = ae_vec)
plot(clasificacion_mask)
writeRaster(clasificacion_mask, "../03salida/clasificacion2014.tif", overwrite = TRUE)
# writeRaster(clasificacion, "../03salida/clasificacion.tif", overwrite = TRUE)
# writeRaster(clasificacion, "../03salida/clasificacion.tif", overwrite = TRUE)




p1 <- createDataPartition(train_df2$class, p = 0.7, list = FALSE)

test <- train_df2[p1,]
test$class2 <- factor(test$class)
class(p1)

(clasificacion0$class)


levels(as.factor(clasificacion0))
levels(as.factor(train_df2$class))

confusionMatrix(data = clasificacion0, reference = train_df2$class)
levels(clasificacion0$class)


train_df2$class <- factor(x = train_df2$class, levels =  levels(clasificacion0) , )
levels(train_df2$class)

```
